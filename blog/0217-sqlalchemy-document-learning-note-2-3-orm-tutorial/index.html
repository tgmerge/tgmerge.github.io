<!DOCTYPE html>
<html lang='zh-cn'>

<head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='本篇是 胡乱 翻译自SQLAlchemy 1.0官方文档 Object Relational Tutorial一章的第三篇笔记。 抱着“反正正事不管时间多少都能干完”的态度果然可以干'>
<meta name='theme-color' content='#ffcd00'>

<meta property='og:title' content='SQLAlchemy文档和笔记 (2.3) - ORM指南 (3) • tgmerge&#39;s blog'>
<meta property='og:description' content='本篇是 胡乱 翻译自SQLAlchemy 1.0官方文档 Object Relational Tutorial一章的第三篇笔记。 抱着“反正正事不管时间多少都能干完”的态度果然可以干'>
<meta property='og:url' content='https://tgmerge.me/blog/0217-sqlalchemy-document-learning-note-2-3-orm-tutorial/'>
<meta property='og:site_name' content='tgmerge&#39;s blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Blog'><meta property='article:tag' content='Python'><meta property='article:tag' content='SQLAlchemy'><meta property='article:tag' content='文档'><meta property='article:tag' content='翻译'><meta property='article:published_time' content='2016-04-30T13:46:00Z'/><meta property='article:modified_time' content='2016-04-30T13:46:00Z'/><meta name='twitter:card' content='summary'><meta name='twitter:site' content='@tgmerge'>

<meta name="generator" content="Hugo 0.40.3" />

  <title>SQLAlchemy文档和笔记 (2.3) - ORM指南 (3) • tgmerge&#39;s blog</title>
  <link rel='canonical' href='https://tgmerge.me/blog/0217-sqlalchemy-document-learning-note-2-3-orm-tutorial/'>
  
  
  <link rel='icon' href='/favicon.png'>
<link rel='stylesheet' href='/assets/css/main.cb99c271.css'><link rel='stylesheet' href='/css/custom.css'><style>
:root{--color-accent:#ffcd00;}
</style>

</head>


<body class='page type-blog'>

  <div class='site'>

    <a class='screen-reader-text' href='#content'></a>

    <div class='main'>

      <nav id='main-menu' class='menu main-menu' aria-label='主菜单'>
  <div class='container'>
    
    <ul><li class='item'>
        <a href='/'>首页</a>
      </li><li class='item'>
        <a href='/blog/'>文章</a>
      </li><li class='item'>
        <a href='/snap/'>图片</a>
      </li><li class='item'>
        <a href='/meow/'>今日彩球</a>
      </li><li class='item'>
        <a href='/about/'>关于</a>
      </li><li class='item'>
        <a href=''></a>
      </li></ul>
  </div>
</nav>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>tgmerge&#39;s blog</p><p class='desc site-desc'></p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='zh-cn' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>SQLAlchemy文档和笔记 (2.3) - ORM指南 (3)</h1>
      

    </div>
    
<div class='entry-meta'>
  <span class='posted-on'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>
<span class='screen-reader-text'>发表于 </span>
  <time class='entry-date' datetime='2016-04-30T13:46:00Z'>2016-04-30</time>
</span>

  
  

</div>


  </div>
</header>

  
  

  <div class='container entry-content'>
  

<p>本篇是 <del>胡乱</del> 翻译自<a href="http://docs.sqlalchemy.org/en/rel_1_0/orm/tutorial.html">SQLAlchemy 1.0官方文档 Object Relational Tutorial一章</a>的第三篇笔记。</p>

<p><del>抱着“反正正事不管时间多少都能干完”的态度果然可以干蛮多其他事情的……</del></p>

<p>各种保留了原文的术语可以参考<a href="http://docs.sqlalchemy.org/en/rel_1_0/glossary.html">SQLAlchemy术语表</a>。</p>

<hr />

<p>上一部分讲的是<code>Query</code>，以及在<code>Query</code>中可以使用的各种查询限定方法。包括分页（<code>offset()</code>和<code>limit()</code>）、筛选（<code>filter()</code>）和其中的多种操作符、获取Scalar（<code>all()</code>和<code>one()</code>等）、计数（<code>count()</code>）之类。</p>

<p>下面从Building a Relationship一节开始。如果在新的REPL中测试之后的python语句，需要还原之前插入的数据，可以使用这个：</p>

<!-- more -->
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># 在REPL中使用下面的语句执行：</span>
<span style="color:#75715e"># exec(open(&#39;path/to/this_file.py&#39;).read())</span>

<span style="color:#f92672">import</span> sqlalchemy
<span style="color:#f92672">from</span> sqlalchemy <span style="color:#f92672">import</span> create_engine, Column, Integer, String, func
<span style="color:#f92672">from</span> sqlalchemy.ext.declarative <span style="color:#f92672">import</span> declarative_base
<span style="color:#f92672">from</span> sqlalchemy.orm <span style="color:#f92672">import</span> sessionmaker

engine <span style="color:#f92672">=</span> create_engine(<span style="color:#e6db74">&#39;sqlite:///:memory:&#39;</span>, echo<span style="color:#f92672">=</span>True)
Base <span style="color:#f92672">=</span> declarative_base()

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">User</span>(Base):
    __tablename__ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;users&#39;</span>
    id <span style="color:#f92672">=</span> Column(Integer, primary_key<span style="color:#f92672">=</span>True)
    name <span style="color:#f92672">=</span> Column(String)
    fullname <span style="color:#f92672">=</span> Column(String)
    password <span style="color:#f92672">=</span> Column(String)
    <span style="color:#66d9ef">def</span> __repr__(self):
       <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&lt;User(name=&#39;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;, fullname=&#39;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;, password=&#39;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;)&gt;&#34;</span> <span style="color:#f92672">%</span> (self<span style="color:#f92672">.</span>name, self<span style="color:#f92672">.</span>fullname, self<span style="color:#f92672">.</span>password)

Base<span style="color:#f92672">.</span>metadata<span style="color:#f92672">.</span>create_all(engine)

Session <span style="color:#f92672">=</span> sessionmaker(bind<span style="color:#f92672">=</span>engine)
session <span style="color:#f92672">=</span> Session()
session<span style="color:#f92672">.</span>add_all([
    User(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;ed&#39;</span>, fullname<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Ed Jones&#39;</span>, password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;f8s7ccs&#39;</span>),
    User(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;wendy&#39;</span>, fullname<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Wendy Williams&#39;</span>, password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;foobar&#39;</span>),
    User(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;mary&#39;</span>, fullname<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Mary Contrary&#39;</span>, password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;xxg527&#39;</span>),
    User(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;fred&#39;</span>, fullname<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Fred Flinstone&#39;</span>, password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;blah&#39;</span>)])
session<span style="color:#f92672">.</span>commit()</code></pre></div>
<h3 id="building-a-relationship-建立关系">Building a Relationship / 建立关系</h3>

<p><del>要建立关系先去表白吧hhh</del></p>

<!-- more -->

<p>比如说，每个<code>User</code>可以保存任意数量的电子邮箱地址。我们需要一个存储电子邮箱地址的新表<code>addresses</code>，然后用一个从<code>users</code>表到<code>addresses</code>表的<strong>一对多</strong>关系来实现。使用declarative系统，我们可以为这个新表定义一个<code>Address</code>映射类：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">from</span> sqlalchemy <span style="color:#f92672">import</span> ForeignKey
<span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">from</span> sqlalchemy.orm <span style="color:#f92672">import</span> relationship

<span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Address</span>(Base):
<span style="color:#f92672">...</span>     __tablename__ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;addresses&#39;</span>
<span style="color:#f92672">...</span>     id <span style="color:#f92672">=</span> Column(Integer, primary_key<span style="color:#f92672">=</span>True)
<span style="color:#f92672">...</span>     email_address <span style="color:#f92672">=</span> Column(String, nullable<span style="color:#f92672">=</span>False)
<span style="color:#f92672">...</span>     user_id <span style="color:#f92672">=</span> Column(Integer, ForeignKey(<span style="color:#e6db74">&#39;users.id&#39;</span>))
<span style="color:#f92672">...</span>
<span style="color:#f92672">...</span>     user <span style="color:#f92672">=</span> relationship(<span style="color:#e6db74">&#34;User&#34;</span>, back_populates<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;addresses&#34;</span>)
<span style="color:#f92672">...</span>
<span style="color:#f92672">...</span>     <span style="color:#66d9ef">def</span> __repr__(self):
<span style="color:#f92672">...</span>         <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&lt;Address(email_address=&#39;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;)&gt;&#34;</span> <span style="color:#f92672">%</span> self<span style="color:#f92672">.</span>email_address
<span style="color:#f92672">...</span>

<span style="color:#f92672">&gt;&gt;&gt;</span> User<span style="color:#f92672">.</span>addresses <span style="color:#f92672">=</span> relationship(<span style="color:#e6db74">&#34;Address&#34;</span>, order_by<span style="color:#f92672">=</span>Address<span style="color:#f92672">.</span>id, back_populates<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;user&#34;</span>)</code></pre></div>
<p>上面这个映射类中出现的<code>ForeignKey</code>，是<code>Column</code>中可以使用的一个描述符(directive)。它声明这个列的值应该被约束于另一列的数据值之中。这是关系数据库的核心功能之一，用于“粘结”两个数据表。上面的<code>ForeignKey</code>表示，<code>address.user_id</code>这一列的值应该被约束于<code>users.id</code>一列。</p>

<p>而描述符<code>relationship()</code>告诉ORM，<code>Address</code>这个类本身应该被连接到<code>User</code>类。连接使用<code>Address.user</code>这个属性。<code>relationship()</code>使用两个表中的外键关联来识别连接的类型，在这里它识别出<code>Address.user</code>应该是一个<strong>多对一</strong>关系。另外一边，<code>User</code>映射类里面也放置了一个<code>relationship()</code>，位于<code>User.addresses</code>属性中。在这两个<code>relationship()</code>描述符中，参数<code>relationship.back_populates</code>被设为“对面”的那个属性，这样一来<code>relationship()</code>就能知道，<code>Address.user</code>是另一边的一个<code>User</code>实例，而<code>User.addresses</code>是另一边的<code>Address</code>实例的列表。</p>

<p>注意：<code>relationship.back_populates</code>替代了过去版本的<code>relationship.backref</code>。<code>relationship.backref</code>参数仍然可用，但<code>relationship.back_populates</code>的名字更容易理解一点。详情可以参考<a href="http://docs.sqlalchemy.org/en/rel_1_0/orm/backref.html#relationships-backref">Linking Relationships with Backref</a>。</p>

<p><strong>多对一</strong>关系从另一边看一定是<strong>一对多</strong>关系。关于更多<code>relationship()</code>的配置案例，可以参看<a href="http://docs.sqlalchemy.org/en/rel_1_0/orm/basic_relationships.html#relationship-patterns">Basic Relationship Patterns</a>。</p>

<p><code>Address.user</code>和<code>User.addresses</code>之间相互的关系构成了SQLAlchemy ORM中的双向关系(bidirectional relationship)。<a href="http://docs.sqlalchemy.org/en/rel_1_0/orm/backref.html#relationships-backref">Linking Relationships with Backref</a>一章详细解释了这种又被称为&rdquo;backref&rdquo;的特性。</p>

<p>传递给<code>relationship()</code>一些表示其他映射类的参数时，如果使用了Declarative系统，你可以用字符串把类名传递过去。所有映射结束的时候，这些字符串将被求值（evaluated）为Python表达式，产生实际的参数。在上面的例子中，实际的参数就是<code>User</code>类。所有继承了declared base的类都可以作为参数。</p>

<p>关于FOREIGN KEY的一点知识：FOREIGN KEY数据列将在它连结的列数据更新的时候，自动更新自己。FOREIGN KEY约束也可以将多个列连结到多个主键列，称为“复合外键”。</p>

<p>接下来需要在数据库中创建<code>addresses</code>表：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> Base<span style="color:#f92672">.</span>metadata<span style="color:#f92672">.</span>create_all(engine)</code></pre></div>
<h3 id="working-with-related-objects-使用包含关系的对象">Working with Related Objects / 使用包含关系的对象</h3>

<p>现在，当我们创建一个<code>User</code>对象的时候，将会包含一个空的<code>addresses</code>集合。默认来说这个集合的数据类型会是list，但也可以用<a href="http://docs.sqlalchemy.org/en/rel_1_0/orm/collections.html#custom-collections">Customizing Collection Access</a>中的方式自定义为其他的集合类型，比如set和dictionary。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> jack <span style="color:#f92672">=</span> User(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;jack&#39;</span>, fullname<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Jack Bean&#39;</span>, password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;gjffdd&#39;</span>)
<span style="color:#f92672">&gt;&gt;&gt;</span> jack<span style="color:#f92672">.</span>addresses
[]</code></pre></div>
<p>你可以任意向<code>User</code>对象中添加<code>Address</code>对象。这里我们直接赋予其一个列表：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> jack<span style="color:#f92672">.</span>addresses <span style="color:#f92672">=</span> [
<span style="color:#f92672">...</span>                 Address(email_address<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;jack@google.com&#39;</span>),
<span style="color:#f92672">...</span>                 Address(email_address<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;j25@yahoo.com&#39;</span>)]</code></pre></div>
<p>当使用双向关系的时候，在一个方向上添加的元素将立即在另一个方向上变得可见。即使当没有任何SQL执行的时候，也是如此：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> jack<span style="color:#f92672">.</span>addresses[<span style="color:#ae81ff">1</span>]
<span style="color:#f92672">&lt;</span>Address(email_address<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;j25@yahoo.com&#39;</span>)<span style="color:#f92672">&gt;</span>

<span style="color:#f92672">&gt;&gt;&gt;</span> jack<span style="color:#f92672">.</span>addresses[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>user
<span style="color:#f92672">&lt;</span>User(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;jack&#39;</span>, fullname<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Jack Bean&#39;</span>, password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;gjffdd&#39;</span>)<span style="color:#f92672">&gt;</span></code></pre></div>
<p>现在让我们将<code>Jack Bean</code>添加到数据库中。<code>jack</code>和它<code>address</code>中的两个<code>Address</code>成员都会一起被级联地（cascading）添加到session中：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> session<span style="color:#f92672">.</span>add(jack)
<span style="color:#f92672">&gt;&gt;&gt;</span> session<span style="color:#f92672">.</span>commit()</code></pre></div>
<p>现在查询Jack，会发现执行的SQL只查询了Jack本身，我们也只得到了Jack本身：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> jack <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>query(User)<span style="color:#f92672">.</span>filter_by(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;jack&#39;</span>)<span style="color:#f92672">.</span>one()
<span style="color:#f92672">&gt;&gt;&gt;</span> jack
<span style="color:#f92672">&lt;</span>User(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;jack&#39;</span>, fullname<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Jack Bean&#39;</span>, password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;gjffdd&#39;</span>)<span style="color:#f92672">&gt;</span></code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">BEGIN</span> (<span style="color:#66d9ef">implicit</span>)
<span style="color:#66d9ef">SELECT</span> users.id <span style="color:#66d9ef">AS</span> users_id,
        users.name <span style="color:#66d9ef">AS</span> users_name,
        users.fullname <span style="color:#66d9ef">AS</span> users_fullname,
        users.password <span style="color:#66d9ef">AS</span> users_password
<span style="color:#66d9ef">FROM</span> users
<span style="color:#66d9ef">WHERE</span> users.name <span style="color:#f92672">=</span> <span style="color:#f92672">?</span>
(<span style="color:#e6db74">&#39;jack&#39;</span>,)</code></pre></div>
<p>现在来看看Jack的<code>addresses</code>属性。会发现下面的SQL立即被执行：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> jack<span style="color:#f92672">.</span>addresses
[<span style="color:#f92672">&lt;</span>Address(email_address<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;jack@google.com&#39;</span>)<span style="color:#f92672">&gt;</span>, <span style="color:#f92672">&lt;</span>Address(email_address<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;j25@yahoo.com&#39;</span>)<span style="color:#f92672">&gt;</span>]</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span> addresses.id <span style="color:#66d9ef">AS</span> addresses_id,
        addresses.email_address <span style="color:#66d9ef">AS</span>
        addresses_email_address,
        addresses.user_id <span style="color:#66d9ef">AS</span> addresses_user_id
<span style="color:#66d9ef">FROM</span> addresses
<span style="color:#66d9ef">WHERE</span> <span style="color:#f92672">?</span> <span style="color:#f92672">=</span> addresses.user_id <span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> addresses.id
(<span style="color:#ae81ff">5</span>,)</code></pre></div>
<p>这是一个<a href="http://docs.sqlalchemy.org/en/rel_1_0/glossary.html#term-lazy-loading">惰性加载/延迟加载（lazy loading）</a>关系的例子。<code>addresses</code>集现在的行为就像普通的列表一样了。之后会讲讲如何优化这种加载方式。</p>

<h3 id="querying-with-joins-含有表连接的查询">Querying with Joins / 含有表连接的查询</h3>

<p>现在可以展示<code>Query</code>的更多功能了。要构造包含<code>User</code>和<code>Address</code>的、最简单的隐式INNER JOIN，可以直接用<code>Query.filter()</code>限定让它们相关联的列相等。比如说：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#66d9ef">for</span> u, a <span style="color:#f92672">in</span> session<span style="color:#f92672">.</span>query(User, address)<span style="color:#f92672">.</span>\
<span style="color:#f92672">...</span>                     filter(User<span style="color:#f92672">.</span>id<span style="color:#f92672">==</span>Address<span style="color:#f92672">.</span>user_id)<span style="color:#f92672">.</span>\
<span style="color:#f92672">...</span>                     filter(Address<span style="color:#f92672">.</span>email_address<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;jack@google.com&#39;</span>)<span style="color:#f92672">.</span>\
<span style="color:#f92672">...</span>                     all():
<span style="color:#f92672">...</span>     <span style="color:#66d9ef">print</span>(u)
<span style="color:#f92672">...</span>     <span style="color:#66d9ef">print</span>(a)
<span style="color:#f92672">&lt;</span>User(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;jack&#39;</span>, fullname<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Jack Bean&#39;</span>, password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;gjffdd&#39;</span>)<span style="color:#f92672">&gt;</span> <span style="color:#f92672">&lt;</span>Address(email_address<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;jack@google.com&#39;</span>)<span style="color:#f92672">&gt;</span></code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span> users.id <span style="color:#66d9ef">AS</span> users_id,
        users.name <span style="color:#66d9ef">AS</span> users_name,
        users.fullname <span style="color:#66d9ef">AS</span> users_fullname,
        users.password <span style="color:#66d9ef">AS</span> users_password,
        addresses.id <span style="color:#66d9ef">AS</span> addresses_id,
        addresses.email_address <span style="color:#66d9ef">AS</span> addresses_email_address,
        addresses.user_id <span style="color:#66d9ef">AS</span> addresses_user_id
<span style="color:#66d9ef">FROM</span> users, addresses
<span style="color:#66d9ef">WHERE</span> users.id <span style="color:#f92672">=</span> addresses.user_id
        <span style="color:#66d9ef">AND</span> addresses.email_address <span style="color:#f92672">=</span> <span style="color:#f92672">?</span>
(<span style="color:#e6db74">&#39;jack@google.com&#39;</span>,)</code></pre></div>
<p>要显式地构造SQL JOIN，使用<code>Query.join()</code>比较容易：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> session<span style="color:#f92672">.</span>query(User)<span style="color:#f92672">.</span>join(Address)<span style="color:#f92672">.</span>\
<span style="color:#f92672">...</span>         filter(Address<span style="color:#f92672">.</span>email_address<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;jack@google.com&#39;</span>)<span style="color:#f92672">.</span>\
<span style="color:#f92672">...</span>         all()
[<span style="color:#f92672">&lt;</span>User(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;jack&#39;</span>, fullname<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Jack Bean&#39;</span>, password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;gjffdd&#39;</span>)<span style="color:#f92672">&gt;</span>]</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span> users.id <span style="color:#66d9ef">AS</span> users_id,
        users.name <span style="color:#66d9ef">AS</span> users_name,
        users.fullname <span style="color:#66d9ef">AS</span> users_fullname,
        users.password <span style="color:#66d9ef">AS</span> users_password
<span style="color:#66d9ef">FROM</span> users <span style="color:#66d9ef">JOIN</span> addresses <span style="color:#66d9ef">ON</span> users.id <span style="color:#f92672">=</span> addresses.user_id
<span style="color:#66d9ef">WHERE</span> addresses.email_address <span style="color:#f92672">=</span> <span style="color:#f92672">?</span>
(<span style="color:#e6db74">&#39;jack@google.com&#39;</span>,)</code></pre></div>
<p><code>Query.join()</code>知道如何连接<code>User</code>和<code>Address</code>，因为他们之间只有一个外键关联。如果没有外键、或有多个外键，<code>Query.join()</code>在下面几种形式下工作得更好：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">query<span style="color:#f92672">.</span>join(Address, User<span style="color:#f92672">.</span>id<span style="color:#f92672">==</span>Address<span style="color:#f92672">.</span>user_id)       <span style="color:#75715e"># 显示声明条件</span>
query<span style="color:#f92672">.</span>join(User<span style="color:#f92672">.</span>addresses)                          <span style="color:#75715e"># 声明左侧到右侧的关系</span>
query<span style="color:#f92672">.</span>join(Address, User<span style="color:#f92672">.</span>addresses)                 <span style="color:#75715e"># 和上一种相同，但显式制定了连结目标</span>
query<span style="color:#f92672">.</span>join(<span style="color:#e6db74">&#39;addresses&#39;</span>)                             <span style="color:#75715e"># 和第二种相同，使用字符串指定</span></code></pre></div>
<p>OUTER JOIN可以用<code>outerjoin()</code>指定：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">query<span style="color:#f92672">.</span>outerjoin(User<span style="color:#f92672">.</span>addresses)   <span style="color:#75715e"># LEFT OUTER JOIN</span></code></pre></div>
<p><code>join()</code>的参考文档会详细说明它可以接受的参数类型和其他使用方法。</p>

<p><strong>注意：</strong>当为<code>Query</code>提供了多个参数的时候，<code>Query.join()</code>默认将首先连接最左边的那个。比如<code>session.query(User, Address).join(Address).all()</code>将执行<code>FROM users JOIN addresses ON users.id = addresses.user_id</code>。如果要改变JOIN的第一项，可以使用<code>Query.select_from()</code>方法：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">query <span style="color:#f92672">=</span> Session<span style="color:#f92672">.</span>query(User, Address)<span style="color:#f92672">.</span>select_from(Address)<span style="color:#f92672">.</span>join(User)
<span style="color:#75715e"># 将执行 FROM addresses JOIN users ON users.id = addresses.user_id</span></code></pre></div>
<h4 id="using-aliases-使用别名">Using Aliases / 使用别名</h4>

<p>当在多个表中查询的时候，如果某张表需要多次在连接中使用，SQL一般需要这张表在多次出现时使用不同的别名作为区分。<code>Query</code>可以用<code>aliased</code>显式地做到这一点。下面，为了查询拥有两个特定的邮箱地址的用户，需要连接<code>Address</code>两次：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">from</span> sqlalchemy.orm <span style="color:#f92672">import</span> aliased
<span style="color:#f92672">&gt;&gt;&gt;</span> adalias1 <span style="color:#f92672">=</span> aliased(Address)
<span style="color:#f92672">&gt;&gt;&gt;</span> adalias2 <span style="color:#f92672">=</span> aliased(Address)
<span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#66d9ef">for</span> username, email1, email2 <span style="color:#f92672">in</span> \
<span style="color:#f92672">...</span>     session<span style="color:#f92672">.</span>query(User<span style="color:#f92672">.</span>name, adalias1<span style="color:#f92672">.</span>email_address, adalias2<span style="color:#f92672">.</span>email_address)<span style="color:#f92672">.</span>\
<span style="color:#f92672">...</span>     join(adalias1, User<span style="color:#f92672">.</span>addresses)<span style="color:#f92672">.</span>\
<span style="color:#f92672">...</span>     join(adalias2, User<span style="color:#f92672">.</span>addresses)<span style="color:#f92672">.</span>\
<span style="color:#f92672">...</span>     filter(adalias1<span style="color:#f92672">.</span>email_address<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;jack@google.com&#39;</span>)<span style="color:#f92672">.</span>\
<span style="color:#f92672">...</span>     filter(adalias2<span style="color:#f92672">.</span>email_address<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;j25@yahoo.com&#39;</span>):
<span style="color:#f92672">...</span>     <span style="color:#66d9ef">print</span>(username, email1, email2)
jack jack<span style="color:#a6e22e">@google.com</span> j25<span style="color:#a6e22e">@yahoo.com</span></code></pre></div>
<h4 id="using-subqueries-使用子查询">Using Subqueries / 使用子查询</h4>

<p><code>Query</code>能生成可被用作子查询的语句。比如说，我们需要获取<code>User</code>和每个<code>User</code>具有<code>Address</code>的数量，最佳的SQL查询方案是按<code>User</code>的id分组获取<code>Address</code>的数量，然后将他们JOIN到<code>User</code>上。为了让没有任何邮箱地址的用户也返回一行数据，我们需要使用LEFT OUTER JOIN。SQL像这样：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span> users.<span style="color:#f92672">*</span>, adr_count.address_count <span style="color:#66d9ef">FROM</span> users <span style="color:#66d9ef">LEFT</span> <span style="color:#66d9ef">OUTER</span> <span style="color:#66d9ef">JOIN</span>
    (<span style="color:#66d9ef">SELECT</span> user_id, <span style="color:#66d9ef">count</span>(<span style="color:#f92672">*</span>) <span style="color:#66d9ef">AS</span> address_count
        <span style="color:#66d9ef">FROM</span> addresses <span style="color:#66d9ef">GROUP</span> <span style="color:#66d9ef">BY</span> user_id) <span style="color:#66d9ef">AS</span> adr_count
    <span style="color:#66d9ef">ON</span> users.id<span style="color:#f92672">=</span>adr_count.user_id</code></pre></div>
<p>使用<code>Query</code>构建语句的时候，需要自内而外。首先，<code>Query</code>的<code>statement</code>属性将返回生成的SQL表达式，在这里这是<code>select()</code>结构的一个实例：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">from</span> sqlalchemy.sql <span style="color:#f92672">import</span> func
<span style="color:#f92672">&gt;&gt;&gt;</span> stmt <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>query(Address<span style="color:#f92672">.</span>user_id, func<span style="color:#f92672">.</span>count(<span style="color:#e6db74">&#39;*&#39;</span>)<span style="color:#f92672">.</span>label(<span style="color:#e6db74">&#39;address_count&#39;</span>))<span style="color:#f92672">.</span>\
<span style="color:#f92672">...</span>         group_by(Address<span style="color:#f92672">.</span>user_id)<span style="color:#f92672">.</span>subquery()</code></pre></div>
<p><code>func</code>将生成SQL函数，而<code>Query</code>的<code>subquery()</code>方法将生成一个SQL表达式结构，代表整个SELECT语句，并包含在一个别名（alias）中。实际上，<code>subquery()</code>是<code>query.statement.alias()</code>的简便写法。</p>

<hr />

<p>Note: 上面这个说法其实蛮乱的……看看这个执行结果可能比较容易理解。<code>Query</code>的<code>statement</code>属性返回了代表这个SQL结构的对象，在这里是<code>AnnotatedSelect</code>，其实是SQLAlchemy内部用于表示一个SELECT的对象。再调用<code>alias()</code>即为它创建了一个别名（和上面<code>aliased()</code>创建的<code>AliasedClass</code>不同）：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> session<span style="color:#f92672">.</span>query(Address<span style="color:#f92672">.</span>user_id, func<span style="color:#f92672">.</span>count(<span style="color:#e6db74">&#39;*&#39;</span>)<span style="color:#f92672">.</span>label(<span style="color:#e6db74">&#39;address_count&#39;</span>))<span style="color:#f92672">.</span>group_by(Address<span style="color:#f92672">.</span>user_id)<span style="color:#f92672">.</span>statement
<span style="color:#f92672">&lt;</span>sqlalchemy<span style="color:#f92672">.</span>sql<span style="color:#f92672">.</span>annotation<span style="color:#f92672">.</span>AnnotatedSelect at <span style="color:#ae81ff">0x1e532da5668</span>; AnnotatedSelect object<span style="color:#f92672">&gt;</span>

<span style="color:#f92672">&gt;&gt;&gt;</span> session<span style="color:#f92672">.</span>query(Address<span style="color:#f92672">.</span>user_id, func<span style="color:#f92672">.</span>count(<span style="color:#e6db74">&#39;*&#39;</span>)<span style="color:#f92672">.</span>label(<span style="color:#e6db74">&#39;address_count&#39;</span>))<span style="color:#f92672">.</span>group_by(Address<span style="color:#f92672">.</span>user_id)<span style="color:#f92672">.</span>statement<span style="color:#f92672">.</span>alias()
<span style="color:#f92672">&lt;</span>sqlalchemy<span style="color:#f92672">.</span>sql<span style="color:#f92672">.</span>selectable<span style="color:#f92672">.</span>Alias at <span style="color:#ae81ff">0x1e532da5860</span>; <span style="color:#f92672">%</span>(<span style="color:#ae81ff">2083912308832</span> anon)s<span style="color:#f92672">&gt;</span></code></pre></div>
<hr />

<p>好现在我们有了一个SQL语句对象（上面的<code>stmt</code>）。它现在的行为和<code>Table</code>就是一样的了。你可以认为，它代表了它查询后的结果。这个语句对象的表列（columns）可以用名为<code>c</code>的属性获取（卧槽啥鬼？）：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#66d9ef">for</span> u, count <span style="color:#f92672">in</span> session<span style="color:#f92672">.</span>query(User, stmt<span style="color:#f92672">.</span>c<span style="color:#f92672">.</span>address_count)<span style="color:#f92672">.</span>\
<span style="color:#f92672">...</span>     outerjoin(stmt, User<span style="color:#f92672">.</span>id<span style="color:#f92672">==</span>stmt<span style="color:#f92672">.</span>c<span style="color:#f92672">.</span>user_id)<span style="color:#f92672">.</span>order_by(User<span style="color:#f92672">.</span>id):
<span style="color:#f92672">...</span>     <span style="color:#66d9ef">print</span>(u, count)
<span style="color:#f92672">&lt;</span>User(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;ed&#39;</span>, fullname<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Ed Jones&#39;</span>, password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;f8s7ccs&#39;</span>)<span style="color:#f92672">&gt;</span> None
<span style="color:#f92672">&lt;</span>User(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;wendy&#39;</span>, fullname<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Wendy Williams&#39;</span>, password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;foobar&#39;</span>)<span style="color:#f92672">&gt;</span> None
<span style="color:#f92672">&lt;</span>User(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;mary&#39;</span>, fullname<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Mary Contrary&#39;</span>, password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;xxg527&#39;</span>)<span style="color:#f92672">&gt;</span> None
<span style="color:#f92672">&lt;</span>User(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;fred&#39;</span>, fullname<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Fred Flinstone&#39;</span>, password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;blah&#39;</span>)<span style="color:#f92672">&gt;</span> None
<span style="color:#f92672">&lt;</span>User(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;jack&#39;</span>, fullname<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Jack Bean&#39;</span>, password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;gjffdd&#39;</span>)<span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">2</span></code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span> users.id <span style="color:#66d9ef">AS</span> users_id,
        users.name <span style="color:#66d9ef">AS</span> users_name,
        users.fullname <span style="color:#66d9ef">AS</span> users_fullname,
        users.password <span style="color:#66d9ef">AS</span> users_password,
        anon_1.address_count <span style="color:#66d9ef">AS</span> anon_1_address_count
<span style="color:#66d9ef">FROM</span> users <span style="color:#66d9ef">LEFT</span> <span style="color:#66d9ef">OUTER</span> <span style="color:#66d9ef">JOIN</span>
    (<span style="color:#66d9ef">SELECT</span> addresses.user_id <span style="color:#66d9ef">AS</span> user_id, <span style="color:#66d9ef">count</span>(<span style="color:#f92672">?</span>) <span style="color:#66d9ef">AS</span> address_count
    <span style="color:#66d9ef">FROM</span> addresses <span style="color:#66d9ef">GROUP</span> <span style="color:#66d9ef">BY</span> addresses.user_id) <span style="color:#66d9ef">AS</span> anon_1
    <span style="color:#66d9ef">ON</span> users.id <span style="color:#f92672">=</span> anon_1.user_id
<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> users.id
(<span style="color:#e6db74">&#39;*&#39;</span>,)</code></pre></div>
<hr />

<p>Note: 上面这个概念也是有点乱orz 意思大概是，子查询（作为其查询结果）可以用做像是<code>User</code>一样的表，直接参与其他查询。其中的表列要用一个<code>c</code>属性访问，和当时定义的一样。在上面，<code>stmt.c</code>中包含<code>stmt.c.user_id</code>和<code>stmt.c.address_count</code>两个子属性，其实就是子查询完成后的表列名称。</p>

<hr />

<h4 id="selecting-entities-from-subqueries-从子查询中选择数据对象">Selecting Entities from Subqueries / 从子查询中选择数据对象</h4>

<p>在上面的例子中，我们只是从子查询中选择了包含一个列（address_count）的结果。如果需要把子查询和数据对象实体对应起来呢？我们可以使用<code>aliased()</code>来关联一个有了别名的映射类和子查询：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> stmt <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>query(Address)<span style="color:#f92672">.</span>filter(Address<span style="color:#f92672">.</span>email_address <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;j25@yahoo.com&#39;</span>)<span style="color:#f92672">.</span>subquery()
<span style="color:#f92672">&gt;&gt;&gt;</span> adalias <span style="color:#f92672">=</span> aliased(Address, stmt)
<span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#66d9ef">for</span> user, address <span style="color:#f92672">in</span> session<span style="color:#f92672">.</span>query(User, adalias)<span style="color:#f92672">.</span>join(adalias, User<span style="color:#f92672">.</span>addresses):
<span style="color:#f92672">...</span>     <span style="color:#66d9ef">print</span>(user)
<span style="color:#f92672">...</span>     <span style="color:#66d9ef">print</span>(address)
<span style="color:#f92672">&lt;</span>User(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;jack&#39;</span>, fullname<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Jack Bean&#39;</span>, password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;gjffdd&#39;</span>)<span style="color:#f92672">&gt;</span>
<span style="color:#f92672">&lt;</span>Address(email_address<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;jack@google.com&#39;</span>)<span style="color:#f92672">&gt;</span></code></pre></div>
<hr />

<p>Note: 上面这种实际上就是给了子查询的结果一个对应的类的别名，区别于上上面那个“把子查询作为一个新的类似于映射类的Table”的方式。上面这种方式的、现有映射类的别名具有现有映射类的所有属性。</p>

<p>另外，用这种方式创建子查询的类别名的时候，最好在子查询的<code>Query()</code>中直接选择整个类，即类似<code>Query(User)</code>的形式，而不是某个属性（如<code>Query(User.id)</code>），否则会自动生成隐式的JOIN，蛮奇怪的（。</p>

<hr />

<h4 id="using-exists-使用exists">Using EXISTS / 使用EXISTS</h4>

<p>SQL中的EXISTS是一个判断某个查询表达式是否包含数据行的布尔操作符。在SQLAlchemy中可以这样表示：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">from</span> sqlalchemy.sql <span style="color:#f92672">import</span> exists
<span style="color:#f92672">&gt;&gt;&gt;</span> stmt <span style="color:#f92672">=</span> exists()<span style="color:#f92672">.</span>where(Address<span style="color:#f92672">.</span>user_id<span style="color:#f92672">==</span>User<span style="color:#f92672">.</span>id)
<span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#66d9ef">for</span> name, <span style="color:#f92672">in</span> session<span style="color:#f92672">.</span>query(User<span style="color:#f92672">.</span>name)<span style="color:#f92672">.</span>filter(stmt):
<span style="color:#f92672">...</span>     <span style="color:#66d9ef">print</span>(name)
jack</code></pre></div>
<p>或者也可以写成</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#66d9ef">for</span> name, <span style="color:#f92672">in</span> session<span style="color:#f92672">.</span>query(User<span style="color:#f92672">.</span>name)<span style="color:#f92672">.</span>filter(exists()<span style="color:#f92672">.</span>where(Address<span style="color:#f92672">.</span>user_id<span style="color:#f92672">==</span>User<span style="color:#f92672">.</span>id)):
<span style="color:#f92672">...</span>     <span style="color:#66d9ef">print</span>(name)
jack</code></pre></div>
<p><code>Query</code>有几个操作符会自动生成EXISTS。上面的这个语句可以在<code>User.addresses</code>关系上用<code>any()</code>改写成：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#66d9ef">for</span> name, <span style="color:#f92672">in</span> session<span style="color:#f92672">.</span>query(User<span style="color:#f92672">.</span>name)<span style="color:#f92672">.</span>filter(User<span style="color:#f92672">.</span>addresses<span style="color:#f92672">.</span>any()):
<span style="color:#f92672">...</span>     <span style="color:#66d9ef">print</span>(name)
jack</code></pre></div>
<p><code>any()</code>也可以加入限制条件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#66d9ef">for</span> name, <span style="color:#f92672">in</span> session<span style="color:#f92672">.</span>query(User<span style="color:#f92672">.</span>name)<span style="color:#f92672">.</span>filter(User<span style="color:#f92672">.</span>addresses<span style="color:#f92672">.</span>any(Address<span style="color:#f92672">.</span>email_address<span style="color:#f92672">.</span>like(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%g</span><span style="color:#e6db74">oogle%&#39;</span>))):
<span style="color:#f92672">...</span>     <span style="color:#66d9ef">print</span>(name)
jack</code></pre></div>
<p><code>has()</code>是和<code>any()</code>类似的操作符，但用于多对一关系（注意<code>~</code>操作符，意为“非”）：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> session<span style="color:#f92672">.</span>query(Address)<span style="color:#f92672">.</span>filter(<span style="color:#f92672">~</span>Address<span style="color:#f92672">.</span>user<span style="color:#f92672">.</span>has(User<span style="color:#f92672">.</span>name<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;jack&#39;</span>))<span style="color:#f92672">.</span>all()
[]</code></pre></div>
<h4 id="common-relationship-operators-常用关系操作符">Common Relationship Operators / 常用关系操作符</h4>

<p>这些操作符用在关系操作上：</p>

<ul>
<li><p><code>__eq__()</code>（多对一关系的“相等”比较）：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">query<span style="color:#f92672">.</span>filter(Address<span style="color:#f92672">.</span>user <span style="color:#f92672">==</span> someuser)</code></pre></div></li>

<li><p><code>__ne__()</code>（多对一关系的“不等”比较）：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">query<span style="color:#f92672">.</span>filter(Address<span style="color:#f92672">.</span>user <span style="color:#f92672">!=</span> someuser)</code></pre></div></li>

<li><p>IS NULL（多对一关系的比较，也用<code>__eq()__</code>实现）：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">query<span style="color:#f92672">.</span>filter(Address<span style="color:#f92672">.</span>user <span style="color:#f92672">==</span> None)</code></pre></div></li>

<li><p><code>contains()</code>（用于一对多关系中的集合）：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">query<span style="color:#f92672">.</span>filter(User<span style="color:#f92672">.</span>addresses<span style="color:#f92672">.</span>contains(someaddress))</code></pre></div></li>

<li><p><code>any()</code>（用于集合）：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">query<span style="color:#f92672">.</span>filter(User<span style="color:#f92672">.</span>addresses<span style="color:#f92672">.</span>any(Address<span style="color:#f92672">.</span>email_address <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;bar&#39;</span>))
    
<span style="color:#75715e"># 也通过命名参数接受比较条件：</span>
query<span style="color:#f92672">.</span>filter(User<span style="color:#f92672">.</span>addresses<span style="color:#f92672">.</span>any(email_address<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;bar&#39;</span>))</code></pre></div></li>

<li><p><code>has()</code>（用于“一”那一侧的引用）：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">query<span style="color:#f92672">.</span>filter(Address<span style="color:#f92672">.</span>user<span style="color:#f92672">.</span>has(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;ed&#39;</span>))</code></pre></div></li>

<li><p><code>Query.with_parent()</code>（用于任意关系，查询关系的另一头是否是某个对象）：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">session<span style="color:#f92672">.</span>query(Address)<span style="color:#f92672">.</span>with_parent(someuser, <span style="color:#e6db74">&#39;addresses&#39;</span>)</code></pre></div>
<p>Note: <code>with_parent()</code>实际上就是查询“关系另一头是某个对象的”这一头的对象。第二个参数用于标明另一头（第一个参数的类型那一头，上面的例子第一个参数是<code>User</code>）和要查询的对象相关联的集合是什么。当这两个映射类只有唯一一个关系的时候，第二个参数是可以省略的。</p></li>
</ul>

<hr />

<blockquote>
<p>ORM指南未完。下一节：Eager Loading</p>
</blockquote>

</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'>
  <div class='tags'>
  <span class='taxonomy-icon'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M20.59,13.41l-7.17,7.17a2,2,0,0,1-2.83,0L2,12V2H12l8.59,8.59A2,2,0,0,1,20.59,13.41Z"/>
  <line x1="7" y1="7" x2="7" y2="7"/>
  
</svg>
</span>
  <span class='screen-reader-text'>标签: </span><a class='tag' href='/tags/python'>Python</a>, <a class='tag' href='/tags/sqlalchemy'>SQLAlchemy</a>, <a class='tag' href='/tags/%E6%96%87%E6%A1%A3'>文档</a>, <a class='tag' href='/tags/%E7%BF%BB%E8%AF%91'>翻译</a></div>

  </div>
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/blog/0216-sqlalchemy-document-learning-note-2-2-orm-tutorial/'>
        <span aria-hidden='true'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>
  
</svg>
 上一篇</span>
        <span class='screen-reader-text'>上一篇: </span>SQLAlchemy文档和笔记 (2.2) - ORM指南 (2)</a>
    </div><div class='next-entry sep-before'>
      <a href='/blog/0218-sqlalchemy-document-learning-note-2-4-orm-tutorial/'>
        <span class='screen-reader-text'>下一篇: </span>SQLAlchemy文档和笔记 (2.4) - ORM指南 (4)<span aria-hidden='true'>下一篇 <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="4" y1="12" x2="20" y2="12"/>
  <polyline points="14 6 20 12 14 18"/>
  
</svg>
</span>
      </a>
    </div></div>
</nav>




      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><div class='copyright'>
  <p> &copy; 2013-2018 tgmerge </p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__public_path__='\/assets\/js\/'</script>

<script src='/assets/js/main.9daad1e6.js'></script><script src='/js/custom.js'></script>
</body>

</html>

